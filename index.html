<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doce Lagom | Confeitaria Artesanal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&family=Montserrat:wght@200;400;600&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        /* ---------- CSS ORIGINAL DA LOJA (MANTIDO) ---------- */
        :root {
            --creme-fundo: #FDFCF9;
            --terroso-luxo: #94745B;
            --menta-seco: #8FA38B;
            --texto: #3E3B39;
            --branco: #FFFFFF;
            --bege-claro: #F4F1ED;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; scroll-behavior: smooth; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--creme-fundo);
            color: var(--texto);
            line-height: 1.4;
            padding-bottom: 100px;
        }
        header {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--branco);
        }
        .logo-container { display: flex; justify-content: center; margin-bottom: 15px; }
        .logo-img { max-width: 180px; height: auto; border-radius: 50%; }
        .slogan { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 1.3rem; margin: 10px 0; }
        .countdown-container { background: var(--bege-claro); padding: 20px; text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(148, 116, 91, 0.1); }
        .countdown-title { font-family: 'Lora', 'Cormorant Garamond', serif; font-style: italic; font-size: 1.05rem; letter-spacing: 0.3px; color: var(--terroso-luxo); margin-bottom: 10px; font-weight: 400; line-height: 1.6; }
        .timer { display: flex; justify-content: center; gap: 15px; }
        .timer-unit { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .timer-val { font-size: 1.4rem; font-weight: 600; color: var(--texto); }
        .timer-label { font-size: 0.6rem; text-transform: uppercase; color: var(--menta-seco); }
        nav { position: sticky; top: 15px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); width: fit-content; margin: 0 auto 40px; padding: 8px 30px; border-radius: 50px; display: flex; gap: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); z-index: 1000; border: 1px solid var(--bege-claro); }
        nav a { text-decoration: none; color: var(--texto); font-size: 0.7rem; letter-spacing: 1.5px; transition: 0.3s; font-weight: 600; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 100px; }
        .section-header { text-align: center; margin: 60px 0 40px; }
        .section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; color: var(--terroso-luxo); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; align-items: start; }
        .card { text-align: center; padding: 20px; background: white; border-radius: 12px; border: 1px solid var(--bege-claro); display: flex; flex-direction: column; position: relative; }
        .card .selector-box:last-of-type { margin-bottom: 10px; }
        .img-container { width: 100%; height: 220px; overflow: hidden; border-radius: 4px; margin-bottom: 15px; background-color: #f9f9f9; position: relative; }
        .badge { position: absolute; bottom: 10px; right: 10px; background: rgba(148, 116, 91, 0.9); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; z-index: 10; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.25rem; margin-bottom: 5px; font-weight: 600; color: var(--terroso-luxo); }
        .product-desc { font-size: 0.75rem; color: #888; margin-bottom: 8px; line-height: 1.4; }
        .selector-box { text-align: left; font-size: 0.75rem; margin: 10px 0 15px; padding: 12px; background: var(--bege-claro); border-radius: 12px; border: 1px solid rgba(148, 116, 91, 0.1); }
        .selector-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--terroso-luxo); background: white; color: var(--terroso-luxo); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-qty:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; }
        .qty-val { font-weight: 600; width: 12px; text-align: center; }
        .btn-add { background: var(--terroso-luxo); color: white; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; width: 100%; margin-top: auto; }
        .btn-add:disabled { background: #bbb; cursor: not-allowed; }
        
        /* Estilos para selos de esgotado */
        .selo-esgotado { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(62, 59, 57, 0.75); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 20; 
            border-radius: 4px; 
            backdrop-filter: blur(2px);
        }
        .selo-esgotado span { 
            background: #E63946; 
            color: white; 
            padding: 12px 25px; 
            border-radius: 50px; 
            font-size: 1.2rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .selo-esgotado-row { 
            background: #E63946; 
            color: white; 
            padding: 4px 12px; 
            border-radius: 50px; 
            font-size: 0.65rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-left: 8px;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .selector-row.row-esgotado { 
            opacity: 0.7; 
            background-color: rgba(230, 57, 70, 0.05);
            border-radius: 8px;
            padding: 4px 8px;
        }
        .selector-row.row-esgotado .btn-qty { 
            border-color: #ccc; 
            color: #ccc; 
            cursor: not-allowed; 
            opacity: 0.5;
        }
        .card.esgotado-total {
            opacity: 0.8;
        }
        .card.esgotado-total .btn-add { 
            background: #bbb; 
            cursor: not-allowed; 
        }

        /* ----- CARRINHO SEMPRE VIS√çVEL ----- */
        .luxury-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--terroso-luxo);
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            transition: 0.3s;
            cursor: pointer;
            display: block;
            border: 2px solid white;
            overflow: hidden;
        }
        .luxury-cart.expandido { width: 320px; height: auto; border-radius: 20px; background: white; padding: 20px; cursor: default; }
        .cart-icon { display: flex; align-items: center; justify-content: center; height: 60px; font-size: 1.5rem; color: white; }
        .cart-content { display: none; }
        .luxury-cart.expandido .cart-content { display: block; }
        .luxury-cart.expandido .cart-icon { display: none; }
        .client-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--bege-claro); margin-bottom: 10px; font-family: 'Montserrat', sans-serif; font-size: 0.85rem; outline: none; }
        .cart-list { max-height: 180px; overflow-y: auto; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--bege-claro); font-size: 0.8rem; }
        .total-box { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid var(--bege-claro); padding-top: 10px; }
        .btn-confirm { background: #25D366; color: white; border: none; padding: 15px; border-radius: 50px; width: 100%; margin-top: 15px; cursor: pointer; font-weight: 600; }
        .btn-clear { background: transparent; border: 1px solid #E0E0E0; color: #999; padding: 8px; border-radius: 50px; font-size: 0.6rem; cursor: pointer; margin-top: 10px; width: 100%; }

        /* ----- MODAL ----- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--branco); padding: 30px; border-radius: 20px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btn { flex: 1; padding: 12px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; font-size: 0.7rem; }
        .m-btn-no { background: #eee; color: #666; }
        .m-btn-yes { background: #E63946; color: white; }

        /* ----- NOTIFICA√á√ÉO ----- */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 50px;
            background: var(--branco);
            color: var(--terroso-luxo);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 3000;
            display: none;
            animation: fadeInOut 3s ease forwards;
        }
        @keyframes fadeInOut {
            0% { top: -50px; opacity: 0; }
            15% { top: 20px; opacity: 1; }
            85% { top: 20px; opacity: 1; }
            100% { top: -50px; opacity: 0; }
        }
        @media (max-width: 600px) { .grid { grid-template-columns: repeat(1, 1fr); } }
    </style>
</head>
<body>

<div id="notification"></div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h3 style="font-family:'Cormorant Garamond'; font-size:1.5rem; color:var(--terroso-luxo)">Limpar Reserva?</h3>
        <p style="font-size:0.8rem; color:#777">Todos os itens ser√£o removidos do carrinho.</p>
        <div class="modal-btns">
            <button class="m-btn m-btn-no" onclick="fecharModal()">Voltar</button>
            <button class="m-btn m-btn-yes" onclick="confirmarLimpeza()">Sim, Limpar</button>
        </div>
    </div>
</div>

<header>
    <div class="logo-container"><img src="https://i.pinimg.com/originals/54/2c/45/542c4582ca79a683b61ad28f926f9efd.png" alt="Logo" class="logo-img"></div>
    <p class="slogan">Onde o menos √©, deliciosamente, mais.</p>
</header>

<div class="countdown-container">
    <p class="countdown-title">Confeitaria artesanal com do√ßura na medida certa. Cada produto √© feito com ingredientes selecionados e muito carinho.</p>
    </div>
</div>

<nav>
    <a href="#trufas">TRUFAS</a>
    <a href="#bolos">BOLOS</a>
    <a href="#combos">COMBOS</a>
</nav>

<div class="container">
    <div id="trufas" class="section-header"><h2>Trufas Artesanais</h2></div>
    <div id="gridTrufas" class="grid"></div>

    <div id="bolos" class="section-header"><h2>Bolos de Pote</h2></div>
    <div id="gridBolos" class="grid"></div>

    <div id="combos" class="section-header"><h2>Nossos Combos</h2></div>
    <div id="gridCombos" class="grid"></div>
</div>

<div class="luxury-cart" id="cartPanel" onclick="expandirCart()">
    <div class="cart-icon">üõí</div>
    <div class="cart-content">
        <h3>Sua Reserva <span onclick="fecharCart(event)" style="float:right; cursor:pointer;">‚úï</span></h3>
        <input type="text" id="clientName" class="client-input" placeholder="Seu nome...">
        <select id="paymentMethod" class="client-input">
            <option value="">Forma de Pagamento...</option>
            <option value="Pix">Pix</option>
            <option value="Dinheiro">Dinheiro</option>
        </select>
        <div id="cartList" class="cart-list"></div>
        <div class="total-box"><span>Total</span><h4 id="totalVal">R$ 0,00</h4></div>
        <button class="btn-confirm" onclick="enviar(event)">Finalizar WhatsApp</button>
        <button class="btn-clear" onclick="abrirModal()">Limpar Tudo üóëÔ∏è</button>
    </div>
</div>

<script>
    // ============================================
    //  LOJA DO LAGOM - COM SELO ESGOTADO VIS√çVEL
    //  LIMITE DE 10 UNIDADES POR PRODUTO
    // ============================================

    // ---------- CONSTANTES ----------
    const STORAGE_PRODUTOS = 'produtos_lagom';
    const STORAGE_ESTOQUE = 'estoque_lagom';
    const STORAGE_PEDIDOS = 'pedidos_lagom';
    const STORAGE_CONFIG = 'config_lagom';
    const ESTOQUE_MAX = 10; // Limite m√°ximo de 10 unidades por produto

    // ---------- PRODUTOS PADR√ÉO ----------
    const produtosPadrao = [
        // Trufas (com varia√ß√µes de tamanho)
        { 
            id: 'mar', 
            nome: 'Maracuj√°', 
            descricao: 'Trufa cremosa com recheio de maracuj√°, equilibrando do√ßura e acidez.', 
            categoria: 'trufas', 
            imagem: 'https://i.ibb.co/d4wBYTPT/b6e504dc-ee33-4c3e-9be3-721ed8f5c3b7.jpg', 
            badge: 'Favorito', 
            tipoPreco: 'variacoes', 
            variacoes: [
                { tamanho: 'M√©dia', preco: 6, key: 'mar-m' }, 
                { tamanho: 'Mini', preco: 4, key: 'mar-mini' }
            ] 
        },
        { 
            id: 'ni', 
            nome: 'Ninho & Nutella', 
            descricao: 'Combina√ß√£o irresist√≠vel de leite Ninho com Nutella em uma trufa macia.', 
            categoria: 'trufas', 
            imagem: 'https://i.ibb.co/vCYCLvML/image.png', 
            badge: 'Favorito', 
            tipoPreco: 'variacoes', 
            variacoes: [
                { tamanho: 'M√©dia', preco: 6, key: 'ni-m' }, 
                { tamanho: 'Mini', preco: 4, key: 'ni-mini' }
            ] 
        },
        { 
            id: 'pa', 
            nome: 'Pa√ßoca', 
            descricao: 'Trufa com o sabor cl√°ssico da pa√ßoca, crocante e irresist√≠vel.', 
            categoria: 'trufas', 
            imagem: 'https://i.ibb.co/JjrwS6gV/4e7c1bd3-101a-47cd-8f6c-dbbaf1f42caf.jpg', 
            badge: '', 
            tipoPreco: 'variacoes', 
            variacoes: [
                { tamanho: 'M√©dia', preco: 6, key: 'pa-m' }, 
                { tamanho: 'Mini', preco: 4, key: 'pa-mini' }
            ] 
        },
        { 
            id: 'caf', 
            nome: 'Caf√©', 
            descricao: 'Trufa com intenso sabor de caf√©, perfeita para os amantes da bebida.', 
            categoria: 'trufas', 
            imagem: 'https://i.ibb.co/0jmQ2JwH/91d96de8-2f80-48fa-a370-7d775f17eb8d.jpg', 
            badge: '', 
            tipoPreco: 'variacoes', 
            variacoes: [
                { tamanho: 'M√©dia', preco: 6, key: 'caf-m' }, 
                { tamanho: 'Mini', preco: 4, key: 'caf-mini' }
            ] 
        },
        // Bolos (pre√ßo √∫nico)
        { 
            id: 'bn', 
            nome: 'Bolo Ninho & Nutella', 
            descricao: 'Camadas de creme de Ninho com Nutella no pote, pura indulg√™ncia.', 
            categoria: 'bolos', 
            imagem: 'https://i.ibb.co/vxf8TJDv/Cantinho-da-G-Wordmark-Logo-1.png', 
            badge: '', 
            tipoPreco: 'unico', 
            preco: 15, 
            key: 'bn' 
        },
        { 
            id: 'bm', 
            nome: 'Bolo Maracuj√°', 
            descricao: 'Bolo de pote refrescante com creme de maracuj√° e massa fofinha.', 
            categoria: 'bolos', 
            imagem: 'https://i.ibb.co/gFXm5yhG/Cantinho-da-G-Wordmark-Logo.png', 
            badge: '', 
            tipoPreco: 'unico', 
            preco: 15, 
            key: 'bm' 
        },
        { 
            id: 'bc', 
            nome: 'Bolo Chocolate', 
            descricao: 'Bolo de pote de chocolate intenso, para os choc√≥latras de plant√£o.', 
            categoria: 'bolos', 
            imagem: 'https://i.ibb.co/wZkd0tZ8/image.png', 
            badge: '', 
            tipoPreco: 'unico', 
            preco: 15, 
            key: 'bc' 
        },
        // Combos
        { 
            id: 'trio', 
            nome: 'Combo Trio M√©dias', 
            descricao: 'Escolha 3 trufas m√©dias dos nossos sabores favoritos.', 
            categoria: 'combos', 
            imagem: 'https://i.ibb.co/7xV904Pc/image.png', 
            badge: 'Mais Pedido', 
            tipo: 'combo', 
            preco: 15, 
            key: 'trio', 
            grupos: [
                { 
                    nome: 'Escolha 3 trufas m√©dias', 
                    limite: 3, 
                    sabores: [
                        { nome: 'Ninho & Nutella', key: 'ni-m', preco: 0 }, 
                        { nome: 'Maracuj√°', key: 'mar-m', preco: 0 }, 
                        { nome: 'Pa√ßoca', key: 'pa-m', preco: 0 }, 
                        { nome: 'Caf√©', key: 'caf-m', preco: 0 }
                    ] 
                }
            ] 
        },
        { 
            id: 'duo', 
            nome: 'Duo Lagom', 
            descricao: '1 bolo de pote + 1 trufa m√©dia, a combina√ß√£o perfeita.', 
            categoria: 'combos', 
            imagem: 'https://i.ibb.co/DfL33q2K/image.png', 
            badge: 'Favorito', 
            tipo: 'combo', 
            preco: 20, 
            key: 'duo', 
            grupos: [
                { 
                    nome: 'Escolha 1 bolo', 
                    limite: 1, 
                    sabores: [
                        { nome: 'Ninho & Nutella', key: 'bn', preco: 0 }, 
                        { nome: 'Maracuj√°', key: 'bm', preco: 0 }, 
                        { nome: 'Chocolate', key: 'bc', preco: 0 }
                    ] 
                },
                { 
                    nome: 'Escolha 1 trufa m√©dia', 
                    limite: 1, 
                    sabores: [
                        { nome: 'Ninho & Nutella', key: 'ni-m', preco: 0 }, 
                        { nome: 'Maracuj√°', key: 'mar-m', preco: 0 }, 
                        { nome: 'Pa√ßoca', key: 'pa-m', preco: 0 }, 
                        { nome: 'Caf√©', key: 'caf-m', preco: 0 }
                    ] 
                }
            ] 
        }
    ];

    // ----- INICIALIZA√á√ÉO DO BANCO DE DADOS -----
    if (!localStorage.getItem(STORAGE_PRODUTOS)) {
        localStorage.setItem(STORAGE_PRODUTOS, JSON.stringify(produtosPadrao));
    }
    if (!localStorage.getItem(STORAGE_ESTOQUE)) {
        localStorage.setItem(STORAGE_ESTOQUE, JSON.stringify({}));
    }
    if (!localStorage.getItem(STORAGE_PEDIDOS)) {
        localStorage.setItem(STORAGE_PEDIDOS, JSON.stringify([]));
    }

    // ---------- VARI√ÅVEIS GLOBAIS ----------
    let qtys = {};
    let cart = [];
    let total = 0;
    let combosSelecao = {};
    let estoqueInterno = JSON.parse(localStorage.getItem(STORAGE_ESTOQUE)) || {};

    // ---------- RENDERIZA√á√ÉO ----------
    function renderizarProdutosLoja() {
        const produtos = JSON.parse(localStorage.getItem(STORAGE_PRODUTOS)) || [];
        const trufas = produtos.filter(p => p.categoria === 'trufas');
        const bolos = produtos.filter(p => p.categoria === 'bolos');
        const combos = produtos.filter(p => p.categoria === 'combos');

        renderizarCategoria('gridTrufas', trufas);
        renderizarCategoria('gridBolos', bolos);
        renderizarCategoria('gridCombos', combos);
        
        // Sempre verificar esgotados ap√≥s renderizar
        setTimeout(verificarEsgotados, 100);
    }

    function renderizarCategoria(gridId, produtos) {
        const grid = document.getElementById(gridId);
        if (!grid) return;
        grid.innerHTML = '';

        produtos.forEach(prod => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.productKey = prod.id;
            if (prod.categoria === 'trufas') {
                card.dataset.trufa = 'true';
            }

            let imgHTML = `<div class="img-container">`;
            if (prod.badge) imgHTML += `<div class="badge">${prod.badge}</div>`;
            imgHTML += `<img src="${prod.imagem || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300'">`;
            imgHTML += `</div>`;

            let variacoesHTML = '';
            let btnAddHTML = '';

            // ----- COMBOS DIN√ÇMICOS -----
            if (prod.categoria === 'combos' && prod.grupos) {
                variacoesHTML = `<div class="selector-box" data-combo-id="${prod.id}">`;
                prod.grupos.forEach((grupo, idxGrupo) => {
                    variacoesHTML += `<p style="margin-top:10px; font-weight:600;">${grupo.nome}</p>`;
                    grupo.sabores.forEach(sabor => {
                        const saborKey = `${prod.id}-${idxGrupo}-${sabor.key}`;
                        variacoesHTML += `
                            <div class="selector-row combo-row" data-grupo="${idxGrupo}" data-sabor-key="${saborKey}" data-prod-id="${prod.id}">
                                <span>${sabor.nome}</span>
                                <div class="controls">
                                    <button class="btn-qty" onclick="changeComboQty('${prod.id}', ${idxGrupo}, '${saborKey}', -1)">-</button>
                                    <span class="qty-val" id="combo-${saborKey}">0</span>
                                    <button class="btn-qty" id="plus-combo-${saborKey}" onclick="changeComboQty('${prod.id}', ${idxGrupo}, '${saborKey}', 1)">+</button>
                                </div>
                            </div>
                        `;
                    });
                });
                variacoesHTML += `</div>`;
                btnAddHTML = `<button class="btn-add" onclick="finalizarCombo('${prod.id}', '${prod.nome}', ${prod.preco})">Reservar Combo</button>`;
            }
            // ----- TRUFAS (M√öLTIPLOS TAMANHOS) -----
            else if (prod.tipoPreco === 'variacoes' && prod.variacoes) {
                variacoesHTML = `<div class="selector-box">`;
                prod.variacoes.forEach(varia => {
                    const qtyId = `qty-${varia.key}`;
                    const plusId = `plus-${varia.key}`;
                    
                    variacoesHTML += `
                        <div class="selector-row" data-size-key="${varia.key}">
                            <span>${varia.tamanho} (R$ ${varia.preco.toFixed(2)})</span>
                            <div class="controls">
                                <button class="btn-qty" onclick="changeQty('${varia.key}', -1)">-</button>
                                <span class="qty-val" id="${qtyId}">0</span>
                                <button class="btn-qty" id="${plusId}" onclick="changeQty('${varia.key}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
                variacoesHTML += `</div>`;
                btnAddHTML = `<button class="btn-add" onclick="addTrufa('${prod.nome}', '${prod.id}')">Reservar</button>`;
            }
            // ----- PRODUTOS DE PRE√áO √öNICO -----
            else {
                const qtyId = `qty-${prod.key}`;
                const plusId = `plus-${prod.key}`;
                
                variacoesHTML = `
                    <span style="font-weight:600; margin-bottom:10px; display:block;">R$ ${prod.preco.toFixed(2)}</span>
                    <div class="selector-box">
                        <div class="selector-row">
                            <span>Qtd:</span>
                            <div class="controls">
                                <button class="btn-qty" onclick="changeQty('${prod.key}', -1)">-</button>
                                <span class="qty-val" id="${qtyId}">0</span>
                                <button class="btn-qty" id="${plusId}" onclick="changeQty('${prod.key}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                `;
                btnAddHTML = `<button class="btn-add" onclick="addItem('${prod.nome}', ${prod.preco}, '${prod.key}')">Reservar</button>`;
            }

            card.innerHTML = `
                ${imgHTML}
                <h3>${prod.nome}</h3>
                <p class="product-desc">${prod.descricao || ''}</p>
                ${variacoesHTML}
                ${btnAddHTML}
            `;

            grid.appendChild(card);
        });

        inicializarQtys(produtos);
        inicializarCombosSelecao(produtos);
    }

    // ---------- INICIALIZA√á√ïES ----------
    function inicializarQtys(produtos) {
        produtos.forEach(prod => {
            if (prod.tipoPreco === 'variacoes' && prod.variacoes) {
                prod.variacoes.forEach(v => { if (!qtys[v.key]) qtys[v.key] = 0; });
            } else if (prod.key) {
                if (!qtys[prod.key]) qtys[prod.key] = 0;
            }
        });
    }

    function inicializarCombosSelecao(produtos) {
        const combos = produtos.filter(p => p.categoria === 'combos' && p.grupos);
        combos.forEach(combo => {
            if (!combosSelecao[combo.id]) {
                combosSelecao[combo.id] = {
                    grupos: combo.grupos.map(g => ({
                        limite: g.limite,
                        total: 0,
                        itens: {}
                    }))
                };
            }
        });
    }

    // ---------- FUN√á√ïES DE QUANTIDADE ----------
    function changeQty(id, delta) {
        if (!qtys[id]) qtys[id] = 0;
        let estoqueUsado = estoqueInterno[id] || 0;
        
        // Verifica se j√° atingiu o limite de 10 unidades
        if (delta > 0 && (estoqueUsado + qtys[id]) >= ESTOQUE_MAX) {
            return mostrarMsg(`Limite de ${ESTOQUE_MAX} unidades atingido para este produto!`);
        }
        
        let n = qtys[id] + delta;
        if (n >= 0) {
            qtys[id] = n;
            let el = document.getElementById(`qty-${id}`);
            if (el) el.innerText = n;
        }
    }

    function addTrufa(sab, key) {
        let qM = qtys[key+'-m'] || 0;
        let qMi = qtys[key+'-mini'] || 0;
        
        if (qM + qMi === 0) return mostrarMsg("Selecione a quantidade!");
        
        // Verifica limite de estoque antes de adicionar
        if (qM > 0) {
            const estoqueM = estoqueInterno[key+'-m'] || 0;
            if (estoqueM + qM > ESTOQUE_MAX) {
                return mostrarMsg(`Limite de ${ESTOQUE_MAX} unidades para trufa m√©dia ${sab}!`);
            }
            estoqueInterno[key+'-m'] = estoqueM + qM;
            addItemCart(`${qM}x Trufa M√©dia (${sab})`, qM * 6);
        }
        if (qMi > 0) {
            const estoqueMi = estoqueInterno[key+'-mini'] || 0;
            if (estoqueMi + qMi > ESTOQUE_MAX) {
                return mostrarMsg(`Limite de ${ESTOQUE_MAX} unidades para trufa mini ${sab}!`);
            }
            estoqueInterno[key+'-mini'] = estoqueMi + qMi;
            addItemCart(`${qMi}x Trufa Mini (${sab})`, qMi * 4);
        }
        
        // Resetar quantidades
        qtys[key+'-m'] = 0;
        qtys[key+'-mini'] = 0;
        
        let elM = document.getElementById(`qty-${key}-m`);
        if (elM) elM.innerText = "0";
        let elMi = document.getElementById(`qty-${key}-mini`);
        if (elMi) elMi.innerText = "0";
        
        salvar();
    }

    function addItem(nome, preco, key) {
        let q = qtys[key] || 0;
        if (q === 0) return mostrarMsg("Selecione a quantidade!");
        
        // Verifica limite de estoque
        const estoqueAtual = estoqueInterno[key] || 0;
        if (estoqueAtual + q > ESTOQUE_MAX) {
            return mostrarMsg(`Limite de ${ESTOQUE_MAX} unidades para ${nome}!`);
        }
        
        estoqueInterno[key] = estoqueAtual + q;
        addItemCart(`${q}x ${nome}`, q * preco);
        
        qtys[key] = 0;
        let el = document.getElementById(`qty-${key}`);
        if (el) el.innerText = "0";
        
        salvar();
    }

    // ---------- FUN√á√ïES PARA COMBOS ----------
    function changeComboQty(comboId, idxGrupo, saborKey, delta) {
        if (!combosSelecao[comboId]) {
            const produtos = JSON.parse(localStorage.getItem(STORAGE_PRODUTOS)) || [];
            const combo = produtos.find(p => p.id === comboId);
            if (combo) {
                combosSelecao[comboId] = {
                    grupos: combo.grupos.map(g => ({ limite: g.limite, total: 0, itens: {} }))
                };
            } else return;
        }

        const grupo = combosSelecao[comboId].grupos[idxGrupo];
        if (!grupo.itens[saborKey]) grupo.itens[saborKey] = 0;

        // Extrair o key do produto real do saborKey
        const keyParts = saborKey.split('-');
        const realKey = keyParts.slice(2).join('-');
        
        // Verificar estoque do produto real
        if (realKey && delta > 0) {
            const estoqueUsado = estoqueInterno[realKey] || 0;
            if (estoqueUsado >= ESTOQUE_MAX) {
                return mostrarMsg("Produto esgotado!");
            }
        }

        let novaQtd = grupo.itens[saborKey] + delta;
        let novoTotalGrupo = grupo.total + delta;

        if (novaQtd >= 0 && novoTotalGrupo <= grupo.limite) {
            grupo.itens[saborKey] = novaQtd;
            grupo.total = novoTotalGrupo;

            const el = document.getElementById(`combo-${saborKey}`);
            if (el) el.innerText = novaQtd;

            const plusBtn = document.getElementById(`plus-combo-${saborKey}`);
            if (plusBtn) plusBtn.disabled = (grupo.total >= grupo.limite);
        }
    }

    function finalizarCombo(comboId, nomeCombo, precoBase) {
        const combo = combosSelecao[comboId];
        if (!combo) return mostrarMsg("Selecione os itens do combo!");

        // Verificar se todos os grupos foram preenchidos
        for (let i = 0; i < combo.grupos.length; i++) {
            if (combo.grupos[i].total === 0) {
                return mostrarMsg(`Preencha todas as escolhas do combo.`);
            }
        }

        // Verificar estoque de cada item do combo
        const produtos = JSON.parse(localStorage.getItem(STORAGE_PRODUTOS)) || [];
        const comboProd = produtos.find(p => p.id === comboId);
        let podeAdicionar = true;
        
        combo.grupos.forEach((grupo, idx) => {
            Object.entries(grupo.itens).forEach(([saborKey, qtd]) => {
                if (qtd > 0) {
                    const keyParts = saborKey.split('-');
                    const realKey = keyParts.slice(2).join('-');
                    
                    if (realKey) {
                        const estoqueUsado = estoqueInterno[realKey] || 0;
                        if (estoqueUsado + qtd > ESTOQUE_MAX) {
                            mostrarMsg(`Produto ${realKey} atingiu limite de ${ESTOQUE_MAX} unidades!`);
                            podeAdicionar = false;
                        }
                    }
                }
            });
        });

        if (!podeAdicionar) return;

        // Buscar os nomes dos sabores escolhidos
        let descricaoItens = [];

        combo.grupos.forEach((grupo, idx) => {
            Object.entries(grupo.itens).forEach(([saborKey, qtd]) => {
                if (qtd > 0) {
                    const keyParts = saborKey.split('-');
                    const realKey = keyParts.slice(2).join('-');
                    
                    for (let g of comboProd.grupos) {
                        for (let s of g.sabores) {
                            if (s.key === realKey) {
                                for (let i = 0; i < qtd; i++) {
                                    descricaoItens.push(s.nome);
                                }
                                
                                // Registrar venda do item individual
                                estoqueInterno[realKey] = (estoqueInterno[realKey] || 0) + qtd;
                            }
                        }
                    }
                }
            });
        });

        const descricao = `${nomeCombo} (${descricaoItens.join(' + ')})`;
        addItemCart(descricao, precoBase);

        salvar();

        // Resetar combo
        delete combosSelecao[comboId];
        
        // Resetar contadores na tela
        document.querySelectorAll(`[data-combo-id="${comboId}"] .qty-val`).forEach(el => el.innerText = '0');
        document.querySelectorAll(`[id^="plus-combo-"]`).forEach(btn => btn.disabled = false);
    }

    // ---------- FUN√á√ïES DO CARRINHO ----------
    function addItemCart(nome, preco) {
        cart.push({ nome, preco });
        total += preco;
        renderCart();
        mostrarMsg("‚ú® Adicionado ao carrinho!");
    }

    function renderCart() {
        const cartList = document.getElementById('cartList');
        if (cartList) {
            cartList.innerHTML = cart.map(i =>
                `<div class="cart-item"><span>${i.nome}</span><strong>R$ ${i.preco.toFixed(2)}</strong></div>`
            ).join('');
        }
        document.getElementById('totalVal').innerText = `R$ ${total.toFixed(2)}`;
    }

    function expandirCart() {
        document.getElementById('cartPanel').classList.add('expandido');
    }

    function fecharCart(e) {
        e.stopPropagation();
        document.getElementById('cartPanel').classList.remove('expandido');
    }

    function abrirModal() {
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function fecharModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    function confirmarLimpeza() {
        cart = [];
        total = 0;
        renderCart();
        fecharModal();
        mostrarMsg("Carrinho limpo!");
    }

    function salvar() {
        localStorage.setItem(STORAGE_ESTOQUE, JSON.stringify(estoqueInterno));
        verificarEsgotados();
    }

    // ---------- VERIFICAR PRODUTOS ESGOTADOS (COM SELOS) ----------
    function verificarEsgotados() {
        console.log("Verificando produtos esgotados...");
        
        document.querySelectorAll('.card').forEach(card => {
            const imgContainer = card.querySelector('.img-container');
            const selectorRows = card.querySelectorAll('.selector-row');
            const btnAdd = card.querySelector('.btn-add');
            let todosEsgotados = true;
            
            // Verificar cada linha do seletor
            selectorRows.forEach(row => {
                const sizeKey = row.dataset.sizeKey;
                if (sizeKey) {
                    const estoqueUsado = estoqueInterno[sizeKey] || 0;
                    const esgotado = estoqueUsado >= ESTOQUE_MAX;
                    
                    // Remover selo existente se houver
                    const seloExistente = row.querySelector('.selo-esgotado-row');
                    
                    if (esgotado) {
                        // Adicionar classe e selo
                        row.classList.add('row-esgotado');
                        if (!seloExistente) {
                            const span = row.querySelector('span');
                            if (span && !span.querySelector('.selo-esgotado-row')) {
                                const selo = document.createElement('span');
                                selo.className = 'selo-esgotado-row';
                                selo.textContent = 'ESGOTADO';
                                span.appendChild(selo);
                            }
                        }
                        
                        // Desabilitar bot√£o +
                        const plusBtn = row.querySelector('.btn-qty:last-child');
                        if (plusBtn) plusBtn.disabled = true;
                    } else {
                        row.classList.remove('row-esgotado');
                        if (seloExistente) seloExistente.remove();
                        
                        // Habilitar bot√£o +
                        const plusBtn = row.querySelector('.btn-qty:last-child');
                        if (plusBtn) plusBtn.disabled = false;
                    }
                    
                    // Verificar se esta linha N√ÉO est√° esgotada
                    if (!esgotado) {
                        todosEsgotados = false;
                    }
                }
            });
            
            // Se TODAS as varia√ß√µes est√£o esgotadas, mostrar selo no card
            if (selectorRows.length > 0 && todosEsgotados) {
                card.classList.add('esgotado-total');
                if (btnAdd) {
                    btnAdd.disabled = true;
                    btnAdd.textContent = 'ESGOTADO';
                }
                
                // Adicionar selo grande na imagem se n√£o existir
                if (!imgContainer.querySelector('.selo-esgotado')) {
                    const seloGrande = document.createElement('div');
                    seloGrande.className = 'selo-esgotado';
                    seloGrande.innerHTML = '<span>ESGOTADO</span>';
                    imgContainer.appendChild(seloGrande);
                }
            } else {
                card.classList.remove('esgotado-total');
                if (btnAdd) {
                    btnAdd.disabled = false;
                    btnAdd.textContent = 'Reservar';
                }
                
                // Remover selo grande se existir
                const seloGrande = imgContainer.querySelector('.selo-esgotado');
                if (seloGrande) seloGrande.remove();
            }
            
            // Caso especial para produtos de pre√ßo √∫nico (sem varia√ß√µes)
            if (selectorRows.length === 0) {
                const key = card.querySelector('[id^="qty-"]')?.id.replace('qty-', '');
                if (key) {
                    const estoqueUsado = estoqueInterno[key] || 0;
                    const esgotado = estoqueUsado >= ESTOQUE_MAX;
                    
                    if (esgotado) {
                        card.classList.add('esgotado-total');
                        if (btnAdd) {
                            btnAdd.disabled = true;
                            btnAdd.textContent = 'ESGOTADO';
                        }
                        
                        if (!imgContainer.querySelector('.selo-esgotado')) {
                            const seloGrande = document.createElement('div');
                            seloGrande.className = 'selo-esgotado';
                            seloGrande.innerHTML = '<span>ESGOTADO</span>';
                            imgContainer.appendChild(seloGrande);
                        }
                    }
                }
            }
        });
        
        console.log("Verifica√ß√£o conclu√≠da");
    }

    // ---------- ENVIO WHATSAPP ----------
    function enviar(e) {
        e.stopPropagation();
        const nome = document.getElementById('clientName').value;
        const pg = document.getElementById('paymentMethod').value;
        
        if (!nome || !pg) {
            return mostrarMsg("Preencha nome e forma de pagamento!");
        }
        if (cart.length === 0) {
            return mostrarMsg("Carrinho vazio!");
        }

        let msg = `*Reserva Doce Lagom*\n*Cliente:* ${nome}\n*Pagamento:* ${pg}\n\n` +
            cart.map(i => `‚Ä¢ ${i.nome}`).join("\n") +
            `\n\n*Total: R$ ${total.toFixed(2)}*`;
        
        window.open(`https://wa.me/558393889854?text=${encodeURIComponent(msg)}`, '_blank');

        // Salvar pedido
        const pedido = {
            id: Date.now().toString(),
            cliente: nome,
            pagamento: pg,
            total: total,
            itens: cart.map(i => i.nome),
            data: new Date().toISOString(),
            status: 'pendente'
        };
        
        let pedidos = JSON.parse(localStorage.getItem(STORAGE_PEDIDOS)) || [];
        pedidos.push(pedido);
        localStorage.setItem(STORAGE_PEDIDOS, JSON.stringify(pedidos));
        
        // Limpar carrinho ap√≥s envio
        cart = [];
        total = 0;
        renderCart();
        document.getElementById('clientName').value = '';
        document.getElementById('paymentMethod').value = '';
        
        mostrarMsg("Pedido enviado com sucesso!");
    }

    function mostrarMsg(texto) {
        const n = document.getElementById('notification');
        n.innerText = texto;
        n.style.display = 'block';
        setTimeout(() => n.style.display = 'none', 2500);
    }

    // ---------- TIMER ----------
    const targetDate = new Date("Feb 06, 2026 00:00:00").getTime();
    setInterval(() => {
        const now = new Date().getTime();
        const dist = targetDate - now;
        if (dist < 0) return;
        document.getElementById("days").innerText = Math.floor(dist / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
        document.getElementById("hours").innerText = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
        document.getElementById("minutes").innerText = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
        document.getElementById("seconds").innerText = Math.floor((dist % (1000 * 60)) / 1000).toString().padStart(2, '0');
    }, 1000);

    // ---------- SINCRONIZA√á√ÉO ----------
    window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_PRODUTOS || e.key === STORAGE_ESTOQUE) {
            estoqueInterno = JSON.parse(localStorage.getItem(STORAGE_ESTOQUE)) || {};
            renderizarProdutosLoja();
        }
    });

    // ---------- INICIALIZA√á√ÉO ----------
    document.addEventListener('DOMContentLoaded', function() {
        renderizarProdutosLoja();
        
        // Verificar esgotados a cada 2 segundos
        setInterval(verificarEsgotados, 2000);
    });
</script>
</body>
</html>

